<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dawei Marketplace - Properties, Air & Car Tickets</title>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1nQ2lcA2kZpmeG6sTQT4WHyrbwd1LPpI&libraries=places" async defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 320px;
            z-index: 10;
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .tab-btn.active {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
        }

        .add-btn {
            width: 100%;
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 8px;
        }

        .add-btn:hover {
            background: #2563eb;
        }

        .tickets-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .tickets-panel.active {
            display: block;
        }

        .tickets-panel h2 {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 15px;
        }

        .ticket-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .ticket-card:hover {
            border-color: #3B82F6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ticket-route {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .ticket-price {
            font-size: 20px;
            font-weight: 700;
            color: #3B82F6;
            margin-bottom: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .btn-primary {
            width: 100%;
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .helper-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .user-profile {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 12px 16px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10;
        }

        .user-profile.active {
            display: flex;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .login-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            margin: auto;
            text-align: center;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .setup-notice {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            z-index: 10000;
            display: none;
        }

        .setup-notice.active {
            display: block;
        }

        .setup-notice h2 {
            color: #dc2626;
            margin-bottom: 15px;
        }

        .setup-notice code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .setup-notice ol {
            text-align: left;
            margin: 20px 0;
            padding-left: 20px;
        }

        .setup-notice li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Setup Notice -->
    <div class="setup-notice active" id="setupNotice">
        <h2>‚öôÔ∏è Supabase Setup Required</h2>
        <p style="margin-bottom: 20px;">Please configure your Supabase credentials in the code:</p>
        <ol>
            <li>Find <code>SUPABASE_URL</code> and <code>SUPABASE_ANON_KEY</code> in the script</li>
            <li>Replace with your actual Supabase project credentials</li>
            <li>Follow the setup instructions provided separately</li>
        </ol>
        <button class="auth-btn" onclick="document.getElementById('setupNotice').style.display='none'">I'll Set This Up</button>
    </div>

    <div id="map"></div>

    <div class="header">
        <h1>Dawei Marketplace</h1>
        <p>Properties, Air & Car Tickets</p>
        
        <div class="category-tabs">
            <button class="tab-btn active" onclick="switchCategory('properties')">üè† Properties</button>
            <button class="tab-btn" onclick="switchCategory('tickets')">‚úàÔ∏è Air</button>
            <button class="tab-btn" onclick="switchCategory('cars')">üöó Cars</button>
        </div>

        <div id="itemCount" style="font-size: 14px; color: #6b7280; margin-bottom: 15px;">
            Loading...
        </div>

        <button class="add-btn" id="addPropertyBtn" onclick="openAddPropertyModal()">‚ûï Post Property</button>
        <button class="add-btn" id="addTicketBtn" onclick="openAddTicketModal()" style="display:none;">‚ûï Post Air Ticket</button>
        <button class="add-btn" id="addCarBtn" onclick="openAddCarModal()" style="display:none;">‚ûï Post Car Ticket</button>
        
        <div style="margin-top: 15px;">
            <button class="auth-btn" id="loginBtn" onclick="signInWithEmail()">Sign In</button>
            <button class="auth-btn" id="signupBtn" onclick="signUpWithEmail()" style="background: #10b981;">Sign Up</button>
        </div>
    </div>

    <!-- User Profile -->
    <div class="user-profile" id="userProfile">
        <div>
            <div id="userName" style="font-weight: 600; color: #1f2937;"></div>
            <div id="userEmail" style="font-size: 12px; color: #6b7280;"></div>
        </div>
        <button class="logout-btn" onclick="signOut()">Logout</button>
    </div>

    <!-- Tickets Panel -->
    <div class="tickets-panel" id="ticketsPanel">
        <h2>‚úàÔ∏è Air Tickets</h2>
        <div id="ticketsList"><div class="loading">Loading tickets...</div></div>
    </div>

    <!-- Cars Panel -->
    <div class="tickets-panel" id="carsPanel">
        <h2>üöó Car Tickets</h2>
        <div id="carsList"><div class="loading">Loading car tickets...</div></div>
    </div>

    <!-- Add Property Modal -->
    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Post Property</h2>
                <button class="close-btn" onclick="closeAddPropertyModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="propertyForm" onsubmit="submitProperty(event)">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" id="title" required>
                    </div>

                    <div class="form-group">
                        <label>Price (Lakh) *</label>
                        <input type="number" id="price" required>
                        <div class="helper-text">Enter in lakh (100,000)</div>
                    </div>

                    <div class="form-group">
                        <label>Full Address (for map) *</label>
                        <input type="text" id="fullAddress" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Bedrooms</label>
                            <input type="number" id="beds" min="0" value="2">
                        </div>
                        <div class="form-group">
                            <label>Bathrooms</label>
                            <input type="number" id="baths" min="0" value="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Square Feet</label>
                        <input type="number" id="sqft" min="0">
                    </div>

                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="description" required rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Contact Phone *</label>
                        <input type="tel" id="contactPhone" required>
                    </div>

                    <div class="form-group">
                        <label>Image URL *</label>
                        <input type="url" id="imageUrl" required>
                    </div>

                    <button type="submit" class="btn-primary">üì§ Post Property</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Ticket Modal -->
    <div id="addTicketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Post Air Ticket</h2>
                <button class="close-btn" onclick="closeAddTicketModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="ticketForm" onsubmit="submitTicket(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>From *</label>
                            <input type="text" id="ticketFrom" required>
                        </div>
                        <div class="form-group">
                            <label>To *</label>
                            <input type="text" id="ticketTo" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Departure Date *</label>
                            <input type="date" id="ticketDepartDate" required>
                        </div>
                        <div class="form-group">
                            <label>Return Date</label>
                            <input type="date" id="ticketReturnDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Airline</label>
                        <input type="text" id="ticketAirline">
                    </div>

                    <div class="form-group">
                        <label>Price (MMK) *</label>
                        <input type="number" id="ticketPrice" required>
                    </div>

                    <div class="form-group">
                        <label>Contact Phone *</label>
                        <input type="tel" id="ticketPhone" required>
                    </div>

                    <button type="submit" class="btn-primary">‚úàÔ∏è Post Ticket</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Car Modal -->
    <div id="addCarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Post Car Ticket</h2>
                <button class="close-btn" onclick="closeAddCarModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="carForm" onsubmit="submitCar(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>From *</label>
                            <input type="text" id="carFrom" required>
                        </div>
                        <div class="form-group">
                            <label>To *</label>
                            <input type="text" id="carTo" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Departure Date *</label>
                            <input type="date" id="carDepartDate" required>
                        </div>
                        <div class="form-group">
                            <label>Departure Time *</label>
                            <input type="time" id="carDepartTime" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Car Type *</label>
                        <select id="carType" required>
                            <option value="sedan">Sedan</option>
                            <option value="suv">SUV</option>
                            <option value="van">Van</option>
                            <option value="bus">Bus</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Available Seats *</label>
                        <input type="number" id="carSeats" required min="1">
                    </div>

                    <div class="form-group">
                        <label>Price per Person (MMK) *</label>
                        <input type="number" id="carPrice" required>
                    </div>

                    <div class="form-group">
                        <label>Contact Phone *</label>
                        <input type="tel" id="carPhone" required>
                    </div>

                    <button type="submit" class="btn-primary">üöó Post Car Ticket</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://zrhslpbtzddtgdifzdhj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyaHNscGJ0emRkdGdkaWZ6ZGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjgwMzMsImV4cCI6MjA3Njc0NDAzM30.r7ylCuNq23tpCctb1MibwHAxU-P549lvDKkqxhalq9s';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let map;
        let geocoder;
        let infoWindow;
        let markers = [];
        let currentCategory = 'properties';
        let currentUser = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        async function initApp() {
            // Check if Supabase is configured
            if (SUPABASE_URL === 'https://zrhslpbtzddtgdifzdhj.supabase.co') {
                console.warn('‚ö†Ô∏è Supabase not configured');
                document.getElementById('setupNotice').classList.add('active');
                return;
            }

            // Initialize map
            initMap();

            // Check for existing session
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showUserProfile();
            }

            // Listen for auth changes
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    showUserProfile();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    hideUserProfile();
                }
            });

            // Load initial data
            loadProperties();
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 14.0825, lng: 98.1892 },
                zoom: 14,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true,
            });

            geocoder = new google.maps.Geocoder();
            infoWindow = new google.maps.InfoWindow();
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        async function signUpWithEmail() {
            const email = prompt('Enter your email:');
            const password = prompt('Create a password (min 6 characters):');
            
            if (!email || !password) return;

            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
            });

            if (error) {
                alert('Sign up error: ' + error.message);
            } else {
                alert('‚úÖ Check your email to confirm your account!');
            }
        }

        async function signInWithEmail() {
            const email = prompt('Enter your email:');
            const password = prompt('Enter your password:');
            
            if (!email || !password) return;

            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                alert('Sign in error: ' + error.message);
            } else {
                alert('‚úÖ Signed in successfully!');
            }
        }

        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                alert('Signed out successfully');
            }
        }

        function showUserProfile() {
            document.getElementById('userProfile').classList.add('active');
            document.getElementById('userName').textContent = currentUser.email.split('@')[0];
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('signupBtn').style.display = 'none';
        }

        function hideUserProfile() {
            document.getElementById('userProfile').classList.remove('active');
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('signupBtn').style.display = 'block';
        }

        // ============================================
        // PROPERTIES
        // ============================================
        async function loadProperties() {
            const { data, error } = await supabase
                .from('properties')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading properties:', error);
                document.getElementById('itemCount').textContent = 'Error loading properties';
                return;
            }

            // Clear existing markers
            markers.forEach(m => m.setMap(null));
            markers = [];

            // Add markers
            data.forEach(property => addMarkerToMap(property));

            document.getElementById('itemCount').textContent = `üìç ${data.length} properties`;
        }

        function addMarkerToMap(property) {
            const marker = new google.maps.Marker({
                position: { lat: property.lat, lng: property.lng },
                map: map,
                title: property.title,
                label: {
                    text: property.price.toString(),
                    color: 'white',
                    fontSize: '12px',
                    fontWeight: 'bold'
                },
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 22,
                    fillColor: '#3B82F6',
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 3,
                }
            });

            marker.addListener('click', () => {
                showPropertyInfo(marker, property);
            });

            markers.push(marker);
        }

        function showPropertyInfo(marker, property) {
            const content = `
                <div style="padding: 10px; max-width: 250px;">
                    <img src="${property.image_url}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" />
                    <h3 style="margin: 0 0 8px 0; font-size: 16px;">${property.title}</h3>
                    <p style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700; color: #3B82F6;">${property.price} lakh</p>
                    <p style="margin: 0 0 4px 0; font-size: 14px; color: #6b7280;">${property.address}</p>
                    <div style="display: flex; gap: 12px; font-size: 14px; color: #6b7280;">
                        <span>üõèÔ∏è ${property.beds}</span>
                        <span>üöø ${property.baths}</span>
                        <span>üìè ${property.sqft || 'N/A'} sqft</span>
                    </div>
                    <p style="margin-top: 8px; font-size: 13px;">${property.description.substring(0, 100)}...</p>
                    <p style="margin-top: 8px; font-size: 14px; font-weight: 600;">üìû ${property.contact_phone}</p>
                </div>
            `;
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        }

        async function submitProperty(event) {
            event.preventDefault();

            if (!currentUser) {
                alert('Please sign in to post properties');
                return;
            }

            const address = document.getElementById('fullAddress').value;

            // Geocode address
            geocoder.geocode({ address: address }, async (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;

                    const { data, error } = await supabase
                        .from('properties')
                        .insert([
                            {
                                title: document.getElementById('title').value,
                                price: document.getElementById('price').value,
                                address: address,
                                beds: document.getElementById('beds').value,
                                baths: document.getElementById('baths').value,
                                sqft: document.getElementById('sqft').value,
                                description: document.getElementById('description').value,
                                contact_phone: document.getElementById('contactPhone').value,
                                image_url: document.getElementById('imageUrl').value,
                                lat: location.lat(),
                                lng: location.lng(),
                                user_id: currentUser.id
                            }
                        ]);

                    if (error) {
                        alert('Error posting property: ' + error.message);
                    } else {
                        alert('‚úÖ Property posted successfully!');
                        closeAddPropertyModal();
                        loadProperties();
                    }
                } else {
                    alert('Could not geocode address. Please try a different address.');
                }
            });
        }

        // ============================================
        // AIR TICKETS
        // ============================================
        async function loadTickets() {
            const { data, error } = await supabase
                .from('air_tickets')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('ticketsList').innerHTML = '<div class="loading">Error loading tickets</div>';
                return;
            }

            const container = document.getElementById('ticketsList');
            if (data.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center;">No air tickets yet</p>';
                return;
            }

            container.innerHTML = data.map(ticket => `
                <div class="ticket-card">
                    <div class="ticket-route">${ticket.from_city} ‚Üí ${ticket.to_city}</div>
                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">üìÖ ${new Date(ticket.depart_date).toLocaleDateString()}</div>
                    <div class="ticket-price">${ticket.price.toLocaleString()} MMK</div>
                    ${ticket.airline ? `<div style="font-size: 13px; color: #6b7280;">‚úàÔ∏è ${ticket.airline}</div>` : ''}
                    <div style="font-size: 14px; margin-top: 8px; font-weight: 600;">üìû ${ticket.contact_phone}</div>
                </div>
            `).join('');

            document.getElementById('itemCount').textContent = `‚úàÔ∏è ${data.length} air tickets`;
        }

        async function submitTicket(event) {
            event.preventDefault();

            if (!currentUser) {
                alert('Please sign in to post tickets');
                return;
            }

            const { data, error } = await supabase
                .from('air_tickets')
                .insert([
                    {
                        from_city: document.getElementById('ticketFrom').value,
                        to_city: document.getElementById('ticketTo').value,
                        depart_date: document.getElementById('ticketDepartDate').value,
                        return_date: document.getElementById('ticketReturnDate').value || null,
                        airline: document.getElementById('ticketAirline').value,
                        price: document.getElementById('ticketPrice').value,
                        contact_phone: document.getElementById('ticketPhone').value,
                        user_id: currentUser.id
                    }
                ]);

            if (error) {
                alert('Error posting ticket: ' + error.message);
            } else {
                alert('‚úÖ Air ticket posted successfully!');
                closeAddTicketModal();
                loadTickets();
            }
        }

        // ============================================
        // CAR TICKETS
        // ============================================
        async function loadCars() {
            const { data, error } = await supabase
                .from('car_tickets')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading cars:', error);
                document.getElementById('carsList').innerHTML = '<div class="loading">Error loading car tickets</div>';
                return;
            }

            const container = document.getElementById('carsList');
            if (data.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center;">No car tickets yet</p>';
                return;
            }

            container.innerHTML = data.map(car => `
                <div class="ticket-card">
                    <div class="ticket-route">${car.from_city} ‚Üí ${car.to_city}</div>
                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">üìÖ ${new Date(car.depart_date).toLocaleDateString()} at ${car.depart_time}</div>
                    <div class="ticket-price">${car.price.toLocaleString()} MMK/person</div>
                    <div style="font-size: 13px; color: #6b7280;">üöó ${car.car_type.charAt(0).toUpperCase() + car.car_type.slice(1)}</div>
                    <div style="font-size: 13px; color: #6b7280;">üí∫ ${car.seats} seats available</div>
                    <div style="font-size: 14px; margin-top: 8px; font-weight: 600;">üìû ${car.contact_phone}</div>
                </div>
            `).join('');

            document.getElementById('itemCount').textContent = `üöó ${data.length} car tickets`;
        }

        async function submitCar(event) {
            event.preventDefault();

            if (!currentUser) {
                alert('Please sign in to post car tickets');
                return;
            }

            const { data, error } = await supabase
                .from('car_tickets')
                .insert([
                    {
                        from_city: document.getElementById('carFrom').value,
                        to_city: document.getElementById('carTo').value,
                        depart_date: document.getElementById('carDepartDate').value,
                        depart_time: document.getElementById('carDepartTime').value,
                        car_type: document.getElementById('carType').value,
                        seats: document.getElementById('carSeats').value,
                        price: document.getElementById('carPrice').value,
                        contact_phone: document.getElementById('carPhone').value,
                        user_id: currentUser.id
                    }
                ]);

            if (error) {
                alert('Error posting car ticket: ' + error.message);
            } else {
                alert('‚úÖ Car ticket posted successfully!');
                closeAddCarModal();
                loadCars();
            }
        }

        // ============================================
        // CATEGORY SWITCHING
        // ============================================
        function switchCategory(category) {
            currentCategory = category;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all panels
            document.getElementById('ticketsPanel').classList.remove('active');
            document.getElementById('carsPanel').classList.remove('active');
            
            // Hide all buttons
            document.getElementById('addPropertyBtn').style.display = 'none';
            document.getElementById('addTicketBtn').style.display = 'none';
            document.getElementById('addCarBtn').style.display = 'none';
            
            if (category === 'properties') {
                document.getElementById('addPropertyBtn').style.display = 'block';
                markers.forEach(m => m.setMap(map));
                loadProperties();
            } else if (category === 'tickets') {
                document.getElementById('addTicketBtn').style.display = 'block';
                document.getElementById('ticketsPanel').classList.add('active');
                markers.forEach(m => m.setMap(null));
                loadTickets();
            } else {
                document.getElementById('addCarBtn').style.display = 'block';
                document.getElementById('carsPanel').classList.add('active');
                markers.forEach(m => m.setMap(null));
                loadCars();
            }
        }

        // ============================================
        // MODAL CONTROLS
        // ============================================
        function openAddPropertyModal() {
            if (!currentUser) {
                alert('Please sign in to post properties');
                return;
            }
            document.getElementById('addPropertyModal').classList.add('active');
        }

        function closeAddPropertyModal() {
            document.getElementById('addPropertyModal').classList.remove('active');
            document.getElementById('propertyForm').reset();
        }

        function openAddTicketModal() {
            if (!currentUser) {
                alert('Please sign in to post tickets');
                return;
            }
            document.getElementById('addTicketModal').classList.add('active');
        }

        function closeAddTicketModal() {
            document.getElementById('addTicketModal').classList.remove('active');
            document.getElementById('ticketForm').reset();
        }

        function openAddCarModal() {
            if (!currentUser) {
                alert('Please sign in to post car tickets');
                return;
            }
            document.getElementById('addCarModal').classList.add('active');
        }

        function closeAddCarModal() {
            document.getElementById('addCarModal').classList.remove('active');
            document.getElementById('carForm').reset();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // ============================================
        // START THE APP
        // ============================================
        window.addEventListener('load', () => {
            // Wait for Google Maps to load
            if (typeof google !== 'undefined') {
                initApp();
            } else {
                setTimeout(initApp, 1000);
            }
        });
    </script>
</body>
</html>
