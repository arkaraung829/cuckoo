<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dawei Marketplace - Properties & Tickets</title>
    
    <!-- Google Maps API - Load first and wait -->
    <script>
        function initGoogleMaps() {
            console.log('Google Maps API loaded successfully');
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1nQ2lcA2kZpmeG6sTQT4WHyrbwd1LPpI&libraries=places&callback=initGoogleMaps"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 320px;
            z-index: 10;
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .tab-btn.active {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
        }

        .tab-btn:hover {
            border-color: #3B82F6;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
            margin-bottom: 15px;
        }

        .add-btn {
            width: 100%;
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 8px;
        }

        .add-btn:hover {
            background: #2563eb;
        }

        .tickets-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .tickets-panel.active {
            display: block;
        }

        .tickets-panel h2 {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 15px;
        }

        .ticket-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .ticket-card:hover {
            border-color: #3B82F6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ticket-route {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .ticket-date {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .ticket-price {
            font-size: 20px;
            font-weight: 700;
            color: #3B82F6;
            margin-bottom: 8px;
        }

        .ticket-seller {
            font-size: 13px;
            color: #6b7280;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 16px;
            z-index: 10;
        }

        .legend-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
            margin-bottom: 8px;
        }

        .legend-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3B82F6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #f3f4f6;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-primary {
            background: #3B82F6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .helper-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .setup-notice {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            z-index: 10000;
            display: none;
        }

        .setup-notice.active {
            display: block;
        }

        .setup-notice h2 {
            color: #dc2626;
            margin-bottom: 15px;
        }

        .setup-notice code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .pac-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 4px;
            z-index: 10001 !important;
        }
    </style>
</head>
<body>
    <!-- Setup Notice -->
    <div class="setup-notice active" id="setupNotice">
        <h2>⚙️ Supabase Setup Required</h2>
        <p style="margin-bottom: 20px;">Please configure your Supabase credentials:</p>
        <ol style="text-align: left; margin: 20px 0; padding-left: 20px;">
            <li style="margin-bottom: 10px;">Find <code>SUPABASE_URL</code> and <code>SUPABASE_ANON_KEY</code> in the script below</li>
            <li style="margin-bottom: 10px;">Replace with your Supabase project URL and anon key</li>
            <li style="margin-bottom: 10px;">Run the SQL setup script in Supabase SQL Editor</li>
        </ol>
        <button class="btn btn-primary" onclick="document.getElementById('setupNotice').style.display='none'">Got It!</button>
    </div>

    <div id="map"></div>

    <div class="header">
        <h1>Dawei Marketplace</h1>
        <p>Properties & Tickets</p>
        
        <div class="category-tabs">
            <button class="tab-btn active" onclick="switchCategory('properties')">🏠 အိမ်ခြံမြေ</button>
            <button class="tab-btn" onclick="switchCategory('tickets')">✈️ လေယာဉ်</button>
            <button class="tab-btn" onclick="switchCategory('cars')">🚗 ကား</button>
        </div>

        <div class="header-info" id="itemCount">
            <span>📍</span>
            <span>Loading...</span>
        </div>
        
        <button class="add-btn" id="addPropertyBtn" onclick="openAddPropertyModal()">➕ အိမ်ခြံမြေတင်ရန်</button>
        <button class="add-btn" id="addTicketBtn" onclick="openAddTicketModal()" style="display:none;">➕ လေယာဉ်လက်မှတ်တင်ရန်</button>
        <button class="add-btn" id="addCarBtn" onclick="openAddCarModal()" style="display:none;">➕ ကားလက်မှတ်တင်ရန်</button>
    </div>

    <!-- Tickets Panel -->
    <div class="tickets-panel" id="ticketsPanel">
        <h2>✈️ လေယာဉ်လက်မှတ်များ</h2>
        <div id="ticketsList">Loading...</div>
    </div>

    <!-- Cars Panel -->
    <div class="tickets-panel" id="carsPanel">
        <h2>🚗 ကားလက်မှတ်များ</h2>
        <div id="carsList">Loading...</div>
    </div>

    <div class="legend" id="propertyLegend">
        <div class="legend-title">မြေပုံအညွှန်း</div>
        <div class="legend-item">
            <div class="legend-marker">$</div>
            <span>အိမ်ခြံမြေတည်နေရာနှင့် ဈေးနှုန်း</span>
        </div>
    </div>

    <!-- Add Property Modal -->
    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>အိမ်ခြံမြေတင်ရန်</h2>
                <button class="close-btn" onclick="closeAddPropertyModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="propertyForm" onsubmit="submitProperty(event)">
                    <div class="form-group">
                        <label>ခေါင်းစဉ် *</label>
                        <input type="text" id="title" required placeholder="ဥပမာ - မြို့လယ်ခေတ်မီဆိုင်ခန်း">
                    </div>

                    <div class="form-group">
                        <label>စျေးနှုန်း (သိန်း) *</label>
                        <input type="number" id="price" required placeholder="ဥပမာ - 3500">
                        <div class="helper-text">သိန်းဖြင့်ဖြည့်ပါ</div>
                    </div>

                    <div class="form-group">
                        <label>လိပ်စာအပြည့်အစုံ *</label>
                        <input type="text" id="fullAddress" required placeholder="ဥပမာ - ရေးလမ်း၊ ထားဝယ်">
                        <div class="helper-text">🔍 စတင်ရိုက်ပါ၊ တည်နေရာများပေါ်လာပါမည်</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>အိပ်ခန်း</label>
                            <input type="number" id="beds" min="0" value="2">
                        </div>
                        <div class="form-group">
                            <label>ရေချိုးခန်း</label>
                            <input type="number" id="baths" min="0" value="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>စတုရန်းပေ</label>
                        <input type="number" id="sqft" min="0" placeholder="ဥပမာ - 1500">
                    </div>

                    <div class="form-group">
                        <label>အသေးစိတ် *</label>
                        <textarea id="description" required placeholder="သင့်အိမ်ခြံမြေ၏ အင်္ဂါရပ်များကို ဖော်ပြပါ..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ဆက်သွယ်ရန် အမည် *</label>
                        <input type="text" id="contactName" required placeholder="သင့်အမည်">
                    </div>

                    <div class="form-group">
                        <label>ဖုန်းနံပါတ် *</label>
                        <input type="tel" id="contactPhone" required placeholder="09-123-456-789">
                    </div>

                    <div class="form-group">
                        <label>ပုံ *</label>
                        <input type="file" id="imageFile" accept="image/*" required onchange="previewImage(event)">
                        <div class="helper-text">သင့်ဖုန်း သို့မဟုတ် ကွန်ပျူတာမှ ပုံရွေးချယ်ပါ</div>
                        <div id="imagePreview" style="margin-top: 12px; display: none;">
                            <img id="previewImg" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px;" />
                        </div>
                        <div id="uploadProgress" style="display: none; margin-top: 8px;">
                            <div style="background: #e5e7eb; border-radius: 8px; height: 8px; overflow: hidden;">
                                <div id="progressBar" style="background: #3B82F6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Uploading... <span id="progressText">0%</span></p>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">📤 တင်မည်</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Ticket Modal -->
    <div id="addTicketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>လေယာဉ်လက်မှတ်တင်ရန်</h2>
                <button class="close-btn" onclick="closeAddTicketModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="ticketForm" onsubmit="submitTicket(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>မှ *</label>
                            <input type="text" id="ticketFrom" required placeholder="ရန်ကုန်">
                        </div>
                        <div class="form-group">
                            <label>သို့ *</label>
                            <input type="text" id="ticketTo" required placeholder="ဘန်ကောက်">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ထွက်ခွာမည့်ရက် *</label>
                            <input type="date" id="ticketDepartDate" required>
                        </div>
                        <div class="form-group">
                            <label>ပြန်လာမည့်ရက်</label>
                            <input type="date" id="ticketReturnDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>လေကြောင်းလိုင်း</label>
                        <input type="text" id="ticketAirline" placeholder="မြန်မာအေးယားဝေး">
                    </div>

                    <div class="form-group">
                        <label>စျေးနှုန်း (ကျပ်) *</label>
                        <input type="number" id="ticketPrice" required placeholder="250000">
                    </div>

                    <div class="form-group">
                        <label>ဖုန်းနံပါတ် *</label>
                        <input type="tel" id="ticketPhone" required placeholder="09-123-456-789">
                    </div>

                    <button type="submit" class="btn btn-primary">✈️ တင်မည်</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Car Modal -->
    <div id="addCarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ကားလက်မှတ်တင်ရန်</h2>
                <button class="close-btn" onclick="closeAddCarModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="carForm" onsubmit="submitCar(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>မှ *</label>
                            <input type="text" id="carFrom" required placeholder="ရန်ကုန်">
                        </div>
                        <div class="form-group">
                            <label>သို့ *</label>
                            <input type="text" id="carTo" required placeholder="မန္တလေး">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ထွက်ခွာမည့်ရက် *</label>
                            <input type="date" id="carDepartDate" required>
                        </div>
                        <div class="form-group">
                            <label>ထွက်ခွာမည့်အချိန် *</label>
                            <input type="time" id="carDepartTime" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ကားအမျိုးအစား *</label>
                        <select id="carType" required>
                            <option value="sedan">ဆီဒန်</option>
                            <option value="suv">SUV</option>
                            <option value="van">ဗန်</option>
                            <option value="bus">ဘတ်စ်ကား</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>လက်ကျန်ခုံနေရာ *</label>
                        <input type="number" id="carSeats" required min="1" placeholder="4">
                    </div>

                    <div class="form-group">
                        <label>စျေးနှုန်း (ကျပ်) *</label>
                        <input type="number" id="carPrice" required placeholder="25000">
                    </div>

                    <div class="form-group">
                        <label>ဖုန်းနံပါတ် *</label>
                        <input type="tel" id="carPhone" required placeholder="09-123-456-789">
                    </div>

                    <button type="submit" class="btn btn-primary">🚗 တင်မည်</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://zrhslpbtzddtgdifzdhj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyaHNscGJ0emRkdGdkaWZ6ZGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjgwMzMsImV4cCI6MjA3Njc0NDAzM30.r7ylCuNq23tpCctb1MibwHAxU-P549lvDKkqxhalq9s';
        
        let supabase = null;
        
        // Only initialize Supabase if configured
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY_HERE') {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase initialized');
            } catch (error) {
                console.error('❌ Supabase initialization error:', error);
                alert('Supabase configuration error. Please check your URL and API key.');
            }
        } else {
            console.warn('⚠️ Supabase not configured - using demo mode');
        }

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let map;
        let geocoder;
        let infoWindow;
        let markers = [];
        let autocomplete;
        let currentCategory = 'properties';

        // ============================================
        // INITIALIZATION
        // ============================================
        let mapInitialized = false;

        function initMap() {
            if (mapInitialized) return;
            
            console.log('Attempting to initialize map...');

            // Check if Supabase is configured
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE') {
                console.warn('⚠️ Supabase not configured');
                document.getElementById('itemCount').innerHTML = '<span>⚙️</span><span>Setup Supabase first</span>';
                // Still show map even without Supabase
            } else {
                document.getElementById('setupNotice').style.display = 'none';
            }

            // Check if Google Maps is loaded
            if (typeof google === 'undefined' || !google.maps) {
                console.error('❌ Google Maps not loaded yet, waiting...');
                return;
            }

            try {
                console.log('✅ Google Maps API available, creating map...');
                
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 14.0825, lng: 98.1892 },
                    zoom: 14,
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true,
                });

                geocoder = new google.maps.Geocoder();
                infoWindow = new google.maps.InfoWindow();

                console.log('✅ Map created successfully!');
                mapInitialized = true;

                // Initialize autocomplete for address input
                setTimeout(function() {
                    const addressInput = document.getElementById('fullAddress');
                    if (addressInput && google.maps.places) {
                        autocomplete = new google.maps.places.Autocomplete(addressInput, {
                            componentRestrictions: { country: 'mm' },
                            fields: ['formatted_address', 'geometry', 'name'],
                            types: ['geocode', 'establishment']
                        });

                        // Set bias to Dawei region
                        const daweiCircle = new google.maps.Circle({
                            center: { lat: 14.0825, lng: 98.1892 },
                            radius: 50000
                        });
                        autocomplete.setBounds(daweiCircle.getBounds());

                        console.log('✅ Autocomplete initialized');
                    }
                }, 1000);

                // Load properties if Supabase is configured
                if (SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE') {
                    loadProperties();
                } else {
                    document.getElementById('itemCount').innerHTML = '<span>📍</span><span>Configure Supabase to load data</span>';
                }

            } catch (error) {
                console.error('❌ Error initializing map:', error);
                alert('Failed to initialize map: ' + error.message);
            }
        }

        // Try multiple times to initialize
        function tryInitMap() {
            console.log('Checking if Google Maps is ready...');
            
            if (typeof google !== 'undefined' && google.maps) {
                console.log('✅ Google Maps ready!');
                initMap();
            } else {
                console.log('⏳ Waiting for Google Maps...');
                setTimeout(tryInitMap, 100);
            }
        }

        // Start when page loads
        window.addEventListener('load', function() {
            console.log('🚀 Page loaded, starting map initialization...');
            tryInitMap();
        });

        // Backup: Try after a delay
        setTimeout(function() {
            if (!mapInitialized) {
                console.log('🔄 Backup initialization attempt...');
                tryInitMap();
            }
        }, 2000);

        // ============================================
        // PROPERTIES
        // ============================================
        async function loadProperties() {
            if (!supabase) {
                console.warn('Supabase not configured - skipping data load');
                document.getElementById('itemCount').innerHTML = '<span>📍</span><span>0 properties (Demo mode)</span>';
                return;
            }

            const { data, error } = await supabase
                .from('properties')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading properties:', error);
                document.getElementById('itemCount').innerHTML = '<span>❌</span><span>Error loading data</span>';
                return;
            }

            markers.forEach(m => m.setMap(null));
            markers = [];

            data.forEach(property => addMarkerToMap(property));

            document.getElementById('itemCount').innerHTML = `<span>📍</span><span>${data.length} properties</span>`;
        }

        function addMarkerToMap(property) {
            const marker = new google.maps.Marker({
                position: { lat: property.lat, lng: property.lng },
                map: map,
                title: property.title,
                label: {
                    text: property.price.toString(),
                    color: 'white',
                    fontSize: '12px',
                    fontWeight: 'bold'
                },
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 22,
                    fillColor: '#3B82F6',
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 3,
                }
            });

            marker.addListener('click', () => {
                showPropertyInfo(marker, property);
            });

            markers.push(marker);
        }

        function showPropertyInfo(marker, property) {
            const content = `
                <div style="padding: 10px; max-width: 250px;">
                    <img src="${property.image_url}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" />
                    <h3 style="margin: 0 0 8px 0; font-size: 16px;">${property.title}</h3>
                    <p style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700; color: #3B82F6;">${property.price} သိန်း</p>
                    <p style="margin: 0 0 4px 0; font-size: 14px; color: #6b7280;">${property.address}</p>
                    <div style="display: flex; gap: 12px; font-size: 14px; color: #6b7280; margin-bottom: 8px;">
                        <span>🛏️ ${property.beds}</span>
                        <span>🚿 ${property.baths}</span>
                        <span>📏 ${property.sqft || 'N/A'} sqft</span>
                    </div>
                    <p style="margin: 8px 0; font-size: 13px;">${property.description.substring(0, 100)}...</p>
                    <p style="margin-top: 8px; font-size: 14px;"><strong>📞 ${property.contact_phone}</strong></p>
                    <p style="margin-top: 4px; font-size: 12px;">👤 ${property.contact_name}</p>
                </div>
            `;
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        }

        async function submitProperty(event) {
            event.preventDefault();

            if (!supabase) {
                alert('⚠️ Supabase not configured! Please add your Supabase URL and API key to enable posting.');
                return;
            }

            const imageFile = document.getElementById('imageFile').files[0];
            if (!imageFile) {
                alert('ပုံရွေးချယ်ပေးပါ');
                return;
            }

            // Show upload progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('progressBar').style.width = '30%';
            document.getElementById('progressText').textContent = '30%';

            // Upload image to Supabase Storage
            const fileExt = imageFile.name.split('.').pop();
            const fileName = `${Math.random().toString(36).substring(2)}-${Date.now()}.${fileExt}`;
            const filePath = `properties/${fileName}`;

            const { data: uploadData, error: uploadError } = await supabase.storage
                .from('property-images')
                .upload(filePath, imageFile);

            if (uploadError) {
                alert('ပုံတင်ရာတွင် အမှားအယွင်းဖြစ်ပွားသည်: ' + uploadError.message);
                document.getElementById('uploadProgress').style.display = 'none';
                console.error(uploadError);
                return;
            }

            document.getElementById('progressBar').style.width = '60%';
            document.getElementById('progressText').textContent = '60%';

            // Get public URL
            const { data: { publicUrl } } = supabase.storage
                .from('property-images')
                .getPublicUrl(filePath);

            document.getElementById('progressBar').style.width = '80%';
            document.getElementById('progressText').textContent = '80%';

            const address = document.getElementById('fullAddress').value;

            geocoder.geocode({ address: address }, async (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;

                    const { data, error } = await supabase
                        .from('properties')
                        .insert([
                            {
                                title: document.getElementById('title').value,
                                price: parseInt(document.getElementById('price').value),
                                address: address,
                                beds: parseInt(document.getElementById('beds').value),
                                baths: parseInt(document.getElementById('baths').value),
                                sqft: parseInt(document.getElementById('sqft').value) || 0,
                                description: document.getElementById('description').value,
                                contact_name: document.getElementById('contactName').value,
                                contact_phone: document.getElementById('contactPhone').value,
                                image_url: publicUrl,
                                lat: location.lat(),
                                lng: location.lng()
                            }
                        ]);

                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressText').textContent = '100%';

                    if (error) {
                        alert('Error posting property: ' + error.message);
                        console.error(error);
                    } else {
                        alert('✅ အိမ်ခြံမြေ တင်ပြီးပါပြီ!');
                        closeAddPropertyModal();
                        loadProperties();
                    }
                } else {
                    alert('မြေပုံတွင် မတွေ့ပါ။ တခြားလိပ်စာဖြင့် ထပ်စမ်းကြည့်ပါ။');
                }
                
                document.getElementById('uploadProgress').style.display = 'none';
            });
        }

        // ============================================
        // AIR TICKETS
        // ============================================
        async function loadTickets() {
            const { data, error } = await supabase
                .from('air_tickets')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('ticketsList').innerHTML = '<p style="color: #ef4444;">Error loading tickets</p>';
                return;
            }

            const container = document.getElementById('ticketsList');
            if (data.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">လေယာဉ်လက်မှတ်မရှိသေးပါ</p>';
                return;
            }

            container.innerHTML = data.map(ticket => `
                <div class="ticket-card">
                    <div class="ticket-route">${ticket.from_city} → ${ticket.to_city}</div>
                    <div class="ticket-date">📅 ${formatDate(ticket.depart_date)}${ticket.return_date ? ' - ' + formatDate(ticket.return_date) : ''}</div>
                    <div class="ticket-price">${ticket.price.toLocaleString()} MMK</div>
                    ${ticket.airline ? `<div class="ticket-seller">✈️ ${ticket.airline}</div>` : ''}
                    <div class="ticket-seller">📞 ${ticket.contact_phone}</div>
                </div>
            `).join('');

            document.getElementById('itemCount').innerHTML = `<span>✈️</span><span>${data.length} air tickets</span>`;
        }

        async function submitTicket(event) {
            event.preventDefault();

            const { data, error } = await supabase
                .from('air_tickets')
                .insert([
                    {
                        from_city: document.getElementById('ticketFrom').value,
                        to_city: document.getElementById('ticketTo').value,
                        depart_date: document.getElementById('ticketDepartDate').value,
                        return_date: document.getElementById('ticketReturnDate').value || null,
                        airline: document.getElementById('ticketAirline').value || null,
                        price: parseInt(document.getElementById('ticketPrice').value),
                        contact_phone: document.getElementById('ticketPhone').value
                    }
                ]);

            if (error) {
                alert('Error posting ticket: ' + error.message);
                console.error(error);
            } else {
                alert('✅ လေယာဉ်လက်မှတ် တင်ပြီးပါပြီ!');
                closeAddTicketModal();
                loadTickets();
            }
        }

        // ============================================
        // CAR TICKETS
        // ============================================
        async function loadCars() {
            const { data, error } = await supabase
                .from('car_tickets')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading cars:', error);
                document.getElementById('carsList').innerHTML = '<p style="color: #ef4444;">Error loading car tickets</p>';
                return;
            }

            const container = document.getElementById('carsList');
            if (data.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">ကားလက်မှတ်မရှိသေးပါ</p>';
                return;
            }

            container.innerHTML = data.map(car => `
                <div class="ticket-card">
                    <div class="ticket-route">${car.from_city} → ${car.to_city}</div>
                    <div class="ticket-date">📅 ${formatDate(car.depart_date)} at ${car.depart_time}</div>
                    <div class="ticket-price">${car.price.toLocaleString()} MMK/person</div>
                    <div class="ticket-seller">🚗 ${car.car_type.charAt(0).toUpperCase() + car.car_type.slice(1)}</div>
                    <div class="ticket-seller">💺 ${car.seats} seats</div>
                    <div class="ticket-seller">📞 ${car.contact_phone}</div>
                </div>
            `).join('');

            document.getElementById('itemCount').innerHTML = `<span>🚗</span><span>${data.length} car tickets</span>`;
        }

        async function submitCar(event) {
            event.preventDefault();

            const { data, error } = await supabase
                .from('car_tickets')
                .insert([
                    {
                        from_city: document.getElementById('carFrom').value,
                        to_city: document.getElementById('carTo').value,
                        depart_date: document.getElementById('carDepartDate').value,
                        depart_time: document.getElementById('carDepartTime').value,
                        car_type: document.getElementById('carType').value,
                        seats: parseInt(document.getElementById('carSeats').value),
                        price: parseInt(document.getElementById('carPrice').value),
                        contact_phone: document.getElementById('carPhone').value
                    }
                ]);

            if (error) {
                alert('Error posting car ticket: ' + error.message);
                console.error(error);
            } else {
                alert('✅ ကားလက်မှတ် တင်ပြီးပါပြီ!');
                closeAddCarModal();
                loadCars();
            }
        }

        // ============================================
        // CATEGORY SWITCHING
        // ============================================
        function switchCategory(category) {
            currentCategory = category;
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('ticketsPanel').classList.remove('active');
            document.getElementById('carsPanel').classList.remove('active');
            
            document.getElementById('addPropertyBtn').style.display = 'none';
            document.getElementById('addTicketBtn').style.display = 'none';
            document.getElementById('addCarBtn').style.display = 'none';
            
            if (category === 'properties') {
                document.getElementById('addPropertyBtn').style.display = 'block';
                document.getElementById('propertyLegend').style.display = 'block';
                markers.forEach(m => m.setMap(map));
                loadProperties();
            } else if (category === 'tickets') {
                document.getElementById('addTicketBtn').style.display = 'block';
                document.getElementById('ticketsPanel').classList.add('active');
                document.getElementById('propertyLegend').style.display = 'none';
                markers.forEach(m => m.setMap(null));
                loadTickets();
            } else {
                document.getElementById('addCarBtn').style.display = 'block';
                document.getElementById('carsPanel').classList.add('active');
                document.getElementById('propertyLegend').style.display = 'none';
                markers.forEach(m => m.setMap(null));
                loadCars();
            }
        }

        // ============================================
        // MODAL CONTROLS
        // ============================================
        function openAddPropertyModal() {
            document.getElementById('addPropertyModal').classList.add('active');
        }

        function closeAddPropertyModal() {
            document.getElementById('addPropertyModal').classList.remove('active');
            document.getElementById('propertyForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
        }

        function openAddTicketModal() {
            document.getElementById('addTicketModal').classList.add('active');
        }

        function closeAddTicketModal() {
            document.getElementById('addTicketModal').classList.remove('active');
            document.getElementById('ticketForm').reset();
        }

        function openAddCarModal() {
            document.getElementById('addCarModal').classList.add('active');
        }

        function closeAddCarModal() {
            document.getElementById('addCarModal').classList.remove('active');
            document.getElementById('carForm').reset();
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }
    </script>
</body>
</html>
